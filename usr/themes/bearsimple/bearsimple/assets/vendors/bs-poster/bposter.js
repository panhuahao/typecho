/*
*
* 根据wbolt开发的WP插件进行修改适配BearSimple主题
*
*/

var bs_poster_conf={};isPosterLoad=true;!function(){for(var t=bs_poster_setting.split("|"),e=["dir","api"],n=0;n<e.length;n++)bs_poster_conf[e[n]]=t[n]}(),jQuery(document).ready(function(c){c(".bearp-bwqr-sticky").length&&c(".bearp-bwqr-sticky").parents().eq(0).addClass("bearp-bwqr-wp");var i={poster:function(){c(document).on("click",".j-bwqr-poster-btn",function(){var n=c("[bear-share-url]").length?c("[bear-share-url]").attr("bear-share-url"):window.location.href;bearui.open({type:"bearui-share-poster",content:'<div class="mobile-share-wrap"><div class="loading">分享图片生成中...</div></div><div class="poster-share-tips">请长按图片，将内容推荐给好友</div>',success:function(){c.ajax({url:decodeURIComponent(bs_poster_conf.api),data:{id:$('#poster-btn').attr('data-cid'),action:"bwqr_ajax",do:"bear_share_poster"},method:"POST",dataType:"json",timeout:6e4,success:function(t){t.callback=function(t){c(".mobile-share-wrap").html('<img src="'+t+'">'),/MicroMessenger/i.test(navigator.userAgent)&&c(".poster-share-tips").show()};var e=new QRious({value:n,padding:5,size:110});t.qrcode=e.toDataURL(),t.head&&t.logo&&t.qrcode?i.canvas(t):bearui.alert("生成分享图片失败<br>"+(t.head?"":"- 头图读取异常")+"<br>"+(t.logo?"":"- logo读取异常")+"<br>"+(t.qrcode?"":"- QRCode读取异常"),function(){bearui.closeAll()})},error:function(){bearui.alert("获取分享图片失败 - time out",function(){bearui.closeAll()})}})}})})},canvas:function(d){var s=document.createElement("canvas"),u=s.getContext("2d"),w=720,l=1100;s.width=w,s.height=1e4;u.fillStyle="#fff",u.fillRect(0,0,s.width,s.height);var f={};switch(poster_theme){case 1:f={bgi:"theme_1.jpg",padding_left:60,padding_top:60,head_width:600,main_width:600,with_content:1,with_domain:0},e(function(){u.fillStyle="#fff",u.fillRect(40,40,640,1020),n(0,function(t){i(t,function(t){o(t,function(t){a(t,function(t){r(t,function(t,e){c(t,e)})})})})})});break;case 2:f={bgi:"theme_2.jpg",padding_left:60,padding_top:270,head_width:600,main_width:600,with_content:1,with_domain:0};var t=d.textlogo;e(function(){u.fillStyle="#fff",u.fillRect(40,f.padding_top-20,640,1080-f.padding_top),u.stroke(),u.fillStyle="#1FAFE9",u.textAlign="center",u.font="500 36px sans-serif",u.fillText(t,360,130,w),n(0,function(t){i(t,function(t){a(t,function(t){r(t,function(t,e){c(t,e)})})})})});break;case 3:f={bgi:"theme_3.png",padding_left:60,padding_top:200,head_width:600,main_width:600,with_content:1,with_domain:0},e(function(){n(0,function(t){i(t,function(t){r(800,function(t,e){c(t,e)})})})});break;default:f={padding_left:40,padding_top:0,head_width:w,main_width:600,with_content:1,with_domain:0},n(0,function(t){i(t,function(t){o(t,function(t){a(t,function(t){r(t,function(t,e){c(t,e)})})})})})}function e(t){var e,n=f.bgi;n?((e=new Image).crossOrigin="anonymous",e.src=decodeURIComponent(bs_poster_conf.dir)+"assets/img/bgi/"+n,e.onerror=function(t){bearui.alert("生成分享图片失败 - 背景图读取异常",function(){bearui.closeAll()})},e.onload=function(){u.drawImage(this,0,0,w,e.height,0,0,w,l),t&&t()}):t&&t()}function n(s,l){var h=new Image;h.crossOrigin="anonymous",d.head.match(/^\/\//)&&(d.head=window.location.protocol+d.head),h.src=d.head,h.onerror=function(t){bearui.alert("生成分享图片失败 - 获取头图异常",function(){bearui.closeAll()})},h.onload=function(){var t=parseInt(2*f.head_width/3),e=parseInt(2*h.width/3),n=0,i=h.width,o=h.height,a=f.head_width,r=t,c=(w-f.head_width)/2,d=f.padding_top;h.height===h.width?(c=parseInt((f.head_width-t)/2)+(w-f.head_width)/2+20,r=a=t-40,d=40+f.padding_top):h.height>e?o=e:h.height<e&&(i=parseInt(3*o/2),n=parseInt((h.width-i)/2)),s+=t+f.padding_top,u.drawImage(this,n,0,i,o,c,d,a,r),l&&l(s)}}function i(t,e){u.stroke(),u.fillStyle="#666",u.textAlign="left",u.font="700 36px sans-serif",t+=80,t=h(document.createElement("div").innerText=d.title,f.padding_left,t,40,u),e&&e(t)}function o(t,e){var n=document.createElement("div");n.innerHTML=d.excerpt,u.textAlign="left",u.fillStyle="#333",u.font="300 28px sans-serif",t+=30,t=h(n.innerHTML,f.padding_left,t,42,u),e&&e(t)}function a(t,e){t+=40,u.lineWidth=1,u.beginPath(),u.strokeStyle="#ededed",u.moveTo(40,t),u.lineTo(680,t),u.stroke(),e&&e(t)}function r(n,i){var o=new Image;o.crossOrigin="anonymous",d.logo.match(/^\/\//)&&(d.logo=window.location.protocol+d.logo),o.src=d.logo,o.onerror=function(t){bearui.alert("生成分享图片失败 - 获取logo图片异常",function(){bearui.closeAll()})},o.onload=function(){n+=60;var t=100<(t=400/o.width*o.height)?100:t,e=o.width/(o.height/t);t=(e=400<e?400:e)/o.width*o.height,u.drawImage(this,0,0,o.width,o.height,f.padding_left,n+(100-t)/2,e,t),i&&i(n,t)}}function c(o,a,r){var c=new Image;c.src=d.qrcode,c.onerror=function(t){bearui.alert("生成分享图片失败 - 二维码生成异常",function(){bearui.closeAll()})},c.onload=function(){var t=w-f.padding_left-100;u.drawImage(this,0,0,100,100,t,o,100,100/c.width*c.height);var e=100/c.width*c.height;o+=a<e?e:a,o=l;var n=u.getImageData(0,0,w,o);s.height=o,u.putImageData(n,0,0);var i=s.toDataURL("image/jpeg",1);d.callback(i),r&&r(o)}}function h(t,e,n,i,o){for(var a=0,r=0,c=0;c<t.length;c++)(a+=o.measureText(t[c]).width)>f.main_width-20&&(o.fillText(t.substring(r,c),e,n),n+=i,a=0,r=c),c==t.length-1&&(o.fillText(t.substring(r,c+1),e,n),n+=i);return n}}};c(".bear-share-poster").length&&i.poster()}),function(t,e){"use strict";var n=decodeURIComponent(bs_poster_conf.dir)+"/bearposter_svg.html",i=bs_poster_conf.ver,o="BEARP_bwqr_SVG_VER",a="BEARP_bwqr_SVG_DATA";if(!e.createElementNS||!e.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect)return;function r(){e.body.insertAdjacentHTML("afterbegin",s)}function c(){e.body?r():e.addEventListener("DOMContentLoaded",r)}var d,s,l="localStorage"in t&&null!==t.localStorage;if(l&&localStorage.getItem(o)===i&&(s=localStorage.getItem(a)))return c();try{(d=new XMLHttpRequest).open("GET",n,!0),d.onload=function(){200<=d.status&&d.status<400&&(s=d.responseText,c(),l&&(localStorage.setItem(a,s),localStorage.setItem(o,i)))},d.send()}catch(t){}}(window,document);